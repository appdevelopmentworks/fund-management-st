# 資金管理シミュレーション & 戦略評価ツール 要件定義書

## 1. ドキュメント情報

- 文書名：資金管理シミュレーション & 戦略評価ツール 要件定義書
- バージョン：v0.1
- 作成日：2025-11-23
- 想定プロトタイプ実装：Python + Streamlit（ローカル）

## 2. システム概要

### 2.1 目的

本システムは、以下の情報を元に資金管理シミュレーションを行い、

- 初期資金
- 戦略ごとの勝率・期待値・トレード履歴
- 資金管理ルール（1トレードあたりの許容リスク、同時最大リスク 等）

を入力すると、

- 資産がどのように増減しうるか（資産曲線・ドローダウン）
- どの程度のリスク％（f）で運用するのが妥当か
- イベント投資戦略と ML／システムトレード戦略を共通の物差しで比較

できることを目的とする。

### 2.2 対象戦略

1. イベント投資（株主優待メイン）
   - 既存の優待イベントアプリで計算した「N営業日前エントリー戦略」の勝率・期待値を入力
2. 機械学習／インジケータ売買プログラム（主に FX）
   - Python側でバックテストロジックを実装し、その結果を資金管理エンジンと連携

## 3. 対象ユーザー・利用形態

- 対象ユーザー：
  - イベント投資・システムトレードを行う個人投資家
  - 自作の売買アルゴリズムを検証するトレーダー
- 利用形態：
  - ローカル 1 ユーザー前提
  - ログイン・マルチユーザー・サーバー運用は考慮しない（v0）
  - プロトタイプは Python + Streamlit で実装

## 4. 対象市場・データソース・前提

- 対象市場：
  - Python でデータが取得できる市場すべて（例：yfinance で取得可能な株式・ETF・FX・先物など）
- 外部データソース：
  - yfinance（価格データ取得、更新は手動・クリックイベントで実行）
- 優待イベントデータ：
  - 既存の優待イベントアプリがデータソース
  - 勝率・期待値などの集計値を入力または CSV からインポート

## 5. 前提条件・非機能的な制約

- 手数料・スリッページ：考慮しない
- 税金：将来拡張に回す（v0 では税引き前ベース）
- 同時保有ポジション数：制約なし
- 口座全体の最大リスク合計：
  - ユーザー設定（デフォルト 8％）
  - 同時保有ポジションの「1トレード最大損失額」の合計が、口座残高 × 上限％ を超えないように調整

## 6. 資金管理モデルの要件

- 初期資金：E0
- 各トレード i：
  - 損益額：P_i
  - 想定最大損失（リスク）：risk_i
  - 取引前口座残高：E_i
- 口座更新式：
  - E_{i+1} = E_i + P_i
- 定義：
  - R 倍数：R_i = P_i / risk_i
  - リスク割合：f_i = risk_i / E_i

### 6.1 資金管理方式

1. Fixed Fractional（固定％リスク）
   - 1 トレードのリスクを「口座残高の f％」とする方式
   - risk_i = f × E_i となるようにロットを自動計算
   - 主に ML／インジ系システムトレード向け

2. フラクショナル・ケリー
   - 入力：勝率 p、R ベース期待値 E_R
   - ケリー f*（単純 2値モデル換算）：f* = (E_R × p) / (E_R - p + 1)
   - 実際に使うリスク：f_safe = c × f*（c は安全係数、0.25〜0.5 程度）
   - 役割：理論上の f* を用いつつ、安全側に寄せた f_safe を Fixed Fractional として利用

3. Fixed Lot / Fixed Notional
   - 「100 株固定」「10 万円分固定」のように、口座残高とは独立したロット指定
   - 主にイベント投資向き
   - システム内部では結果的に生じた risk_i / E_i を暗黙のリスク割合 f_i として記録

## 7. シミュレーション機能

### 7.1 入力条件（共通）

- 初期資金 E0
- 資金管理方式：
  - Fixed Fractional（f 指定）
  - Fractional Kelly（p, E_R, 安全係数 c）
  - Fixed Lot / Fixed Notional
- 口座全体の同時最大リスク合計（デフォルト 8％）
- シミュレーション対象戦略：
  - イベント投資戦略
  - ML／インジ戦略

### 7.2 出力（必須）

- 資産曲線（Equity Curve）
- ドローダウン曲線（最大 DD・DD 期間）
- 勝率・トレード数
- 平均損益（円・％・R）
- R 期待値 E[R]
- CAGR（年率換算成長率）
- 同時リスク合計の推移（最大値）
- 各トレードの f_i（リスク％）分布（平均・最大）

### 7.3 モンテカルロシミュレーション（v0 目標）

- トレード履歴をランダムシャッフルまたはリサンプリングして複数パスを生成
- 各パスに同じ資金管理ルールを適用し、資産曲線を生成
- 出力：
  - 最終資産分布
  - CAGR 分布
  - 最大 DD 分布
  - N トレード後／N 年後に資産が増えている確率

### 7.4 破産確率（バルサラ簡易版）

- 入力：勝率 p、損益比（平均利益／平均損失）、1 トレードリスク f
- 出力：破産確率（Risk of Ruin）、f を変化させた場合の破産確率一覧

## 8. データ入出力仕様

### 8.1 トレード履歴 CSV

- エンコーディング：UTF-8（BOM なし）
- 区切り文字：カンマ
- 1 行目：ヘッダー
- 想定列：
  - trade_id：トレード ID
  - strategy_id：戦略 ID（イベント／ML／インジなど）
  - instrument：銘柄コードまたはシンボル（例：7203.T, USDJPY=X）
  - market：市場区分（任意：JP, US, FX 等）
  - entry_datetime：エントリー日時（YYYY-MM-DD HH:MM:SS）
  - exit_datetime：エグジット日時
  - side：LONG／SHORT
  - entry_price：エントリー価格
  - exit_price：エグジット価格
  - stop_price：想定ストップ価格（任意）
  - quantity：取引数量（株数／ロット数）
  - comment：任意コメント

### 8.2 イベント戦略集計 CSV（オプション）

- 既存優待イベントアプリから集計値のみインポートする場合：
  - strategy_id：戦略 ID（例：YUTAI_N5）
  - description：説明（例：権利日 5 営業日前買い翌日売り）
  - n_trades：トレード数
  - win_rate：勝率（0〜1）
  - avg_R：R ベース期待値（任意）
  - avg_pnl_ratio：1 トレードあたり資産比の期待値（任意）

### 8.3 プリセット保存形式

- 形式：JSON
- 保存対象：
  - 戦略の選択・パラメータ
  - 資金管理設定（初期資金、f、ケリー係数 c、同時最大リスクなど）
  - 表示設定（期間、グラフオプションなど）

## 9. UI 要件（Streamlit プロトタイプ）

- トップ画面：
  - 戦略選択（イベント／ML）
  - CSV インポート
  - プリセット読み込み
- 設定画面：
  - 初期資金入力
  - 資金管理方式選択
  - f、p、E_R、c などの入力
  - 同時最大リスク合計％の入力
- 結果画面：
  - 資産曲線
  - ドローダウン曲線
  - 指標一覧（勝率・期待値・E[R]・CAGR・MaxDD・破産確率など）
- モンテカルロ画面（可能なら）：
  - 試行回数入力
  - 分布グラフ表示
- プリセット管理画面：
  - プリセット名入力
  - 保存・読み込み・削除
